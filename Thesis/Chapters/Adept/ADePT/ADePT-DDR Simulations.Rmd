---
title: "ADePT-DDR OC updated stopping rules"
author: "Amit Patel"
date: "15/01/2020"
output: html_document
  
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

library(pocrm)
library(kableExtra)
library(knitr)
library(dplyr)
source('Functions.R')

```

# Stop when 15 at recommended dose 
## Enter function specifications 

N.B These are not all the required specifications for the simulation function to run, just those which won't be altered in all the scenarios simulated.

```{r}
# Specifiy the possible orderings.
orders<-matrix(nrow=2,ncol=6)
orders[1,]<-c(1,2,3,4,5,6)
orders[2,]<-c(1,2,3,5,4,6)

# Specify the skeleton values.
skeleton <- getprior(0.05,0.25,5,6)
skeleton
# Initial guesses of toxicity probabilities for each ordering.
alpha <- getwm(orders,skeleton)
# We consider all orders to be equally likely prior to the study.
prior.o <- rep(1/2,2)
# Initial escalation scheme.
x0 <- c(2,3,4,5,6)
# Number of patients used to define stopping rule
stop <- 61
# Maximum sample size.
n <- 60
# The target toxicity rate
theta <- 0.25
# Number of simulations
nsim <- 2000
# Definition of acceptable DLT rates
tox.range<-0.05 
# The cohort size
cohort <- 3
# The Observation window specified in days add 49 due too 7 week treatment period
obswin <- 365 + 49
# The minimum follow up period specified in days
minfu <- 56 + 49
# The second observation window in days
win2 <- 84 +49 
# The number of patients recruited per observation window
recrate <- 14 # Roughly 1 patient every 30 days
# The number of patients we need to see at a dose to stop the trial early
mtd.lim <- 15
# The value for which the estimated toxicity at the lowest dose is not to exceed
tox.lim <- 0.35
# The probability value to be used when assessing the certainty required that toxicty at the specificed dose exceeds tox_lim
tox.cert <- 0.8
```


## Initial Simulations

### MTD at dose -1

```{r}

# True toxicity rates of Scenario 1
r <- c(0.25, 0.40, 0.45, 0.50, 0.55, 0.60)
set.seed(101)
fit_s1 <- titepocrm_sim(r, alpha, prior.o, x0, stop, n, theta, nsim, 
                        tox.range, cohort, obswin, minfu, win2, recrate,
                        mtd.lim, tox.lim, tox.cert)
fit_s1
```

### MTD at dose 0

```{r}

# True toxicity rates of scenario 2
r <- c(0.12 ,0.25, 0.40, 0.45, 0.50, 0.55)
set.seed(102)
fit_s2 <- titepocrm_sim(r, alpha, prior.o, x0, stop, n, theta, nsim, 
                        tox.range, cohort, obswin, minfu, win2, recrate,                                mtd.lim, tox.lim, tox.cert)
fit_s2

```

###  MTD at dose 1

```{r}
# True toxicity rates of scenario 3
r <- c(0.09 ,0.12 ,0.25, 0.40, 0.45, 0.50)
set.seed(103)
fit_s3 <- titepocrm_sim(r, alpha, prior.o, x0, stop, n, theta, nsim, 
                        tox.range, cohort, obswin, minfu, win2, recrate,                                mtd.lim, tox.lim, tox.cert)
fit_s3

```

### MTD at dose 2a

```{r}
# True toxicity rates of Scenario 4
r <- c(0.06, 0.09, 0.12, 0.25, 0.40, 0.45)
set.seed(104)
fit_s4 <-titepocrm_sim(r, alpha, prior.o, x0, stop, n, theta, nsim, 
                        tox.range, cohort, obswin, minfu, win2, recrate,                                mtd.lim, tox.lim, tox.cert)
fit_s4
```

### MTD at dose 2b

```{r}
# True toxicity rates of scenario 5
r <- c(0.03, 0.06, 0.09, 0.12 ,0.25, 0.40)
set.seed(105)
fit_s5 <- titepocrm_sim(r, alpha, prior.o, x0, stop, n, theta, nsim, 
                        tox.range, cohort, obswin, minfu, win2, recrate,                                mtd.lim, tox.lim, tox.cert)
fit_s5

```

### MTD at dose 3

```{r}
# True toxicity rates of scenario 6
r <- c(0.01, 0.03, 0.06, 0.09, 0.12 ,0.25)
set.seed(106)
fit_s6 <- titepocrm_sim(r, alpha, prior.o, x0, stop, n, theta, nsim, 
                        tox.range, cohort, obswin, minfu, win2, recrate,                                mtd.lim, tox.lim, tox.cert)
fit_s6

```

### Equal steps
```{r}
# True toxicity rates of scenario 7
r <- c(0.05, 0.10, 0.15, 0.20 ,0.25 ,0.30)
set.seed(107)
fit_s7 <- titepocrm_sim(r, alpha, prior.o, x0, stop, n, theta, nsim, 
                        tox.range, cohort, obswin, minfu, win2, recrate,                                mtd.lim, tox.lim, tox.cert)
fit_s7

```

### All too toxic 
```{r}
# True toxicity rates when all too toxic
r <- c(0.50, 0.60, 0.65, 0.70 ,0.75 ,0.8)
set.seed(108)
fit_s8 <- titepocrm_sim(r, alpha, prior.o, x0, stop, n, theta, nsim, 
                        tox.range, cohort, obswin, minfu, win2, recrate,                                mtd.lim, tox.lim, tox.cert)
fit_s8

```


```{r}

OC_tab <- 
  rbind(round(skeleton,2),
        fit_s1$true.prob, c(fit_s1$MTD.selection, fit_s1$stop), 
        fit_s1$patient.allocation, round(fit_s1$mean.n.perdose,2), 
        fit_s2$true.prob,  c(fit_s2$MTD.selection, fit_s2$stop),
        fit_s2$patient.allocation, round(fit_s2$mean.n.perdose,2),
        fit_s3$true.prob,  c(fit_s3$MTD.selection, fit_s3$stop),
        fit_s3$patient.allocation, round(fit_s3$mean.n.perdose,2),
        fit_s4$true.prob,  c(fit_s4$MTD.selection, fit_s4$stop),
        fit_s4$patient.allocation, round(fit_s4$mean.n.perdose,2),
        fit_s5$true.prob,  c(fit_s5$MTD.selection, fit_s5$stop), 
        fit_s5$patient.allocation, round(fit_s5$mean.n.perdose,2),
        fit_s6$true.prob,  c(fit_s6$MTD.selection, fit_s6$stop),
        fit_s6$patient.allocation, round(fit_s6$mean.n.perdose,2),
        fit_s7$true.prob,  c(fit_s7$MTD.selection, fit_s7$stop),
        fit_s7$patient.allocation,round(fit_s7$mean.n.perdose,2),
        fit_s8$true.prob,  c(fit_s8$MTD.selection, fit_s8$stop), 
        fit_s8$patient.allocation, round(fit_s8$mean.n.perdose,2))

temp <- (OC_tab[,7]) 
a <- 1:33
a <- a[-c(3,7,11,15,19,23,27,31)]
temp[a] <- " " 
OC_tab[,7] <- temp
colnames(OC_tab)<- c("-1", "0", "1", "2a", "2b", "3", "Stop")
OC_tab <- as.matrix(cbind(c("Scenario", rep("1: TD25 @-1",4), rep("2: TD25 @0",4), rep("3: TD25 @1",4), rep("4: TD25 @2a",4), rep("5: TD25 @2b",4),   rep("6: TD25 @3",4), rep("7: Equal steps in DLT rate",4), rep("8: All  toxic",4)), c("Prior DLT", rep(c("True DLT rate", "P(select)", "% of patients", "Mean number of patients"),8)), OC_tab))
OC_tab
```



```{r, comment=NA}
code <-kable(OC_tab, "latex", booktabs = T, linesep = "", align = "c", 
            caption = " Operating Characteristics of the two-stage PO TITE-CRM (using true DLT rates which imply dose level 2b is more toxic than 2a) in eight different scenarios based on 2000 simulated trials of 60 patients in cohorts of three. Definitions: DLT: Dose-limiting toxicity. P(select):
Probability of selecting a dose as the MTD.") %>%
        kable_styling(latex_options = c("striped", "HOLD_position"),
                      position = "center",
                      stripe_index = c(2:5, 10:13, 18:21, 26:29)) %>% 
        add_header_above(c(" " = 2,"Dose Levels" = 6)) %>% 
        collapse_rows(columns = 1:2, latex_hline = "major",  valign = "middle") 

cat(code)

```



## Simulations for model 2 

### MTD at dose -1

```{r}

# True toxicity rates of Scenario 1
r <- c(0.25, 0.40, 0.45, 0.55, 0.50, 0.60)
set.seed(109)
fit2_s1 <- titepocrm_sim(r, alpha, prior.o, x0, stop, n, theta, nsim, 
                        tox.range, cohort, obswin, minfu, win2, recrate,                                mtd.lim, tox.lim, tox.cert)
fit2_s1
```

### MTD at dose 0

```{r}

# True toxicity rates of scenario 2
r <- c(0.12 ,0.25, 0.40, 0.50, 0.45, 0.55)
set.seed(110)
fit2_s2 <- titepocrm_sim(r, alpha, prior.o, x0, stop, n, theta, nsim, 
                        tox.range, cohort, obswin, minfu, win2, recrate,                                mtd.lim, tox.lim, tox.cert)
fit2_s2

```

###  MTD at dose 1

```{r}
# True toxicity rates of scenario 3
r <- c(0.09 ,0.12 ,0.25, 0.45, 0.40, 0.50)
set.seed(111)
fit2_s3 <- titepocrm_sim(r, alpha, prior.o, x0, stop, n, theta, nsim, 
                        tox.range, cohort, obswin, minfu, win2, recrate,                                mtd.lim, tox.lim, tox.cert)
fit2_s3

```

### MTD at dose 2a

```{r}
# True toxicity rates of Scenario 4
r <- c(0.06, 0.09, 0.12, 0.25, 0.15, 0.45)
#r <- c(0.03, 0.06, 0.09, 0.25, 0.12, 0.40) # new for presentation
set.seed(112)
fit2_s4 <-titepocrm_sim(r, alpha, prior.o, x0, stop, n, theta, nsim, 
                        tox.range, cohort, obswin, minfu, win2, recrate,                                mtd.lim, tox.lim, tox.cert)
fit2_s4
```

### MTD at dose 2b

```{r}
# True toxicity rates of scenario 5
r <- c(0.03, 0.06, 0.09, 0.35 ,0.25, 0.40)
#r <- c(0.03, 0.06, 0.12, 0.4 ,0.25, 0.45) # new for presentation
set.seed(113)
fit2_s5 <- titepocrm_sim(r, alpha, prior.o, x0, stop, n, theta, nsim, 
                        tox.range, cohort, obswin, minfu, win2, recrate,                                mtd.lim, tox.lim, tox.cert)
fit2_s5

```

### MTD at dose 3

```{r}
# True toxicity rates of scenario 6
r <- c(0.01, 0.03, 0.06, 0.12, 0.09 ,0.25)
set.seed(114)
fit2_s6 <- titepocrm_sim(r, alpha, prior.o, x0, stop, n, theta, nsim, 
                        tox.range, cohort, obswin, minfu, win2, recrate,                                mtd.lim, tox.lim, tox.cert)
fit2_s6

```

### Equal steps
```{r}
# True toxicity rates of scenario 7
r <- c(0.05, 0.10, 0.15, 0.25 ,0.20 ,0.30)
set.seed(115)
fit2_s7 <- titepocrm_sim(r, alpha, prior.o, x0, stop, n, theta, nsim, 
                        tox.range, cohort, obswin, minfu, win2, recrate,                                mtd.lim, tox.lim, tox.cert)
fit2_s7

```

### All too toxic 
```{r}
# True toxicity rates when all too toxic
r <- c(0.5, 0.60, 0.65, 0.75 ,0.70 ,0.8)

set.seed(116)
fit2_s8 <- titepocrm_sim(r, alpha, prior.o, x0, stop, n, theta, nsim, 
                        tox.range, cohort, obswin, minfu, win2, recrate,
                        mtd.lim, tox.lim, tox.cert)
fit2_s8

```


```{r, comment=NA}


OC_tab2 <- 
  rbind(round(skeleton,2),
        fit2_s1$true.prob, c(fit2_s1$MTD.selection, fit2_s1$stop), 
        fit2_s1$patient.allocation, round(fit2_s1$mean.n.perdose,2), 
        fit2_s2$true.prob,  c(fit2_s2$MTD.selection, fit2_s2$stop),
        fit2_s2$patient.allocation, round(fit2_s2$mean.n.perdose,2),
        fit2_s3$true.prob,  c(fit2_s3$MTD.selection, fit2_s3$stop),
        fit2_s3$patient.allocation, round(fit2_s3$mean.n.perdose,2),
        fit2_s4$true.prob,  c(fit2_s4$MTD.selection, fit2_s4$stop),
        fit2_s4$patient.allocation, round(fit2_s4$mean.n.perdose,2),
        fit2_s5$true.prob,  c(fit2_s5$MTD.selection, fit2_s5$stop), 
        fit2_s5$patient.allocation, round(fit2_s5$mean.n.perdose,2),
        fit2_s6$true.prob,  c(fit2_s6$MTD.selection, fit2_s6$stop),
        fit2_s6$patient.allocation, round(fit2_s6$mean.n.perdose,2),
        fit2_s7$true.prob,  c(fit2_s7$MTD.selection, fit2_s7$stop),
        fit2_s7$patient.allocation,round(fit2_s7$mean.n.perdose,2),
        fit2_s8$true.prob,  c(fit2_s8$MTD.selection, fit2_s8$stop), 
        fit2_s8$patient.allocation, round(fit2_s8$mean.n.perdose,2))

temp <- (OC_tab2[,7]) 
a <- 1:33
a <- a[-c(3,7,11,15,19,23,27,31)]
temp[a] <- " " 
OC_tab2[,7] <- temp
colnames(OC_tab2)<- c("-1", "0", "1", "2a", "2b", "3", "Stop")
OC_tab2 <- as.matrix(cbind(c("Scenario", rep("9: TD25 @-1",4), rep("10: TD25 @0",4), rep("11: TD25 @1",4), rep("12: TD25 @2a",4), rep("13: TD25 @2b",4),   rep("14: TD25 @3",4), rep("15: Equal steps in DLT rate",4), rep("16: All  toxic",4)), c("Prior DLT", rep(c("True DLT rate", "P(select)", "% of patients", "Mean number of patients"),8)), OC_tab2))
OC_tab2
```



```{r, comment=NA}
code2 <-kable(OC_tab2, "latex", booktabs = T, linesep = "", align = "c", 
            caption = " Operating Characteristics of the two-stage PO TITE-CRM (using true DLT rates which imply dose level 2a is more toxic than 2b) in eight different scenarios based on 2000 simulated trials of 60 patients in cohorts of three. Definitions: DLT: Dose-limiting toxicity. P(select):
Probability of selecting a dose as the MTD.") %>%
        kable_styling(latex_options = c("striped", "HOLD_position"),
                      position = "center",
                      stripe_index = c(2:5, 10:13, 18:21, 26:29)) %>% 
        add_header_above(c(" " = 2,"Dose Levels" = 6)) %>% 
        collapse_rows(columns = 1:2, latex_hline = "major",  valign = "middle") 

cat(code2)

```

```{r}
save.image(file = 'ADePT-DDR_OC.RData')
```
